\documentclass{article}[12pt]
\input{preamble}
\title{Calclations used in obtaining Simlib Variables from OpSim outputs}
\begin{document}
\maketitle
\section{Counts and Magnitudes}
We can find the number counts (ADU) due to an astrophysical point object with a 
Spectral Energy Distribution $F_{\nu}(\nu) = \frac{d E(\nu)}{d \nu}$ as follows:
in a transmission band $b$ as follows:
\be
N(ADU)  =  \frac{S\Delta T}{g} \int d\nu F_{\nu}(\nu) T_b (\nu)({h\nu})^{-1}
\ee
where $S$ is the effective collecting area of the telescope.
The magnitude of the source in the same transmission band $b$ is defined to be
\be
10.0^{-0.4 m_b} = \frac{\int d\nu F_{\nu}(\nu) T_b(\nu)({h\nu})^{-1}}
{\int d\nu S_{\nu}(\nu) T_b(\nu)(h\nu)^{-1}}
\label{def:mag}
\ee
where $S(\nu)$ is the reference spectrum which has the value of 3631 Jy for AB magnitudes, as in OpSim.
Combining these, we have
\beqn
N(ADU) &=& \frac{S \Delta T}{hg} 10^{-0.4(m_b)}
\int \frac{d\nu}{\nu} S_{\nu}(\nu) T_b(\nu)  \\
       &=& 10.0^{-0.4(m_b - zp)}
\eeqn
So, that 
\be
zp = 2.5 \log_{10}\left(\frac{S \Delta T}{hg}(\int \frac{d\nu}{\nu} S_{\nu}(\nu) T_b(\nu) )\right)
\label{eqn:physicalzp}
\ee
\subsection{Source Counts}
For an astrophysical source, the transmission function is the total transmission function:
\be
T_{tot}(\nu) = T_{sys}(\nu) T_{atm}(\nu)
\ee

\subsection{Sky Counts}
Two things are different for sky counts:
\begin{itemize}
    \item Sky brightness is expressed in terms of magnitude per arcsecond square. To get the number of photons from the sky, one does not find the effective magnitude by multiplying the brightness by the effective area in arcsec squared and then find the number of photons as suggested by the unit, but find the number of photons from the magnitude and multiply by the effective area in arcsec squared as would be sensible by logic.  
    \item These magnitudes are computed using Eqn.~\ref{def:mag} with the transmission function being the system transmission function only, without the atmospheric component. Thus, the zero points defined through Eqn.~\ref{eqn:physicalzp} are 
different for the case of the sky and the sources, but the transmission functions are not very different.
\end{itemize}
\be
N_{sky}(ADU) = Area 10.0^{-0.4(m_b - zp_{sky})}
\label{Nsky}
\ee

\section{SkySig Calculation}
The noise in observations is easy to determine as the square root of the number
of photoelectrons in the 'observed' area. We will not discuss the aperture or
observed area, but find the numbers from the magnitudes by using 'zero points'.

\be
\frac{N_{signal}}{N_{total}^{0.5}} = SNR
\label{eqn:m5}
\ee
\subsection{Full Calculation}
\beqn
N_{total} &=& N_{sky} + N_{source} \\
          &=& A 10.0^{-0.4(m_{sky} - zp_{sky})} + 10.0^{-0.4(m_{source} -zp_{source})} \\
          &=& A 10.0^{-0.4(m_{sky} - zp_{sky})}\left( 1.0 +
            \frac{10.0^{-0.4(m_{source} - m_{sky})}}
                 {A 10.0^{-0.4(zp_{source}- zp_{sky})}}
        \right)
\eeqn

Plugging into Eqn.~\ref{eqn:m5}, we get:
\beqn
\left(10.0^{-0.4(m^b_5 - zp_{source})}\right)^2
&=& SNR^2 N_{tot}\\ 
2(m^b_5 - zp_{source}) &=& -2.5 \log_{10}(SNR^2 A) 
        + m_{sky} - zp_{sky} \nonumber\\
     &-& 2.5\log_{10}
     \left( 1.0 +
        \frac{10.0^{-0.4(m_{source} - m_{sky})}}
             {A 10.0^{-0.4(zp_{source}- zp_{sky})}} 
     \right)
\eeqn

This gives us:
\beqn
2 zp_{source} - zp_{sky} = 
2 m^b_5 - m^{b}_{sky} + 2.5 \log_{10}(SNR^2 A) + \nonumber \\  
2.5 \log_{10} \left( 1.0 +
                    \frac{10.0^{-0.4(m^b_{5} - m_{sky})}}
                         {A 10.0^{-0.4(zp_{source}- zp_{sky})}}
              \right)
\eeqn
\subsection{Atmospheric Transmission approximately unity}

If the transmission through the atmosphere is approximately unity, the total 
transmission is entirely due to the system transmission. In this case, 
\be
zp_{source} \approx zp_{sys}
\ee
through Eqn.~\ref{eqn:physicalzp}.
In this case, the zero point reduces to:
\beqn
zp_{source} &=& 2 m^b_5 - m^b_{sky} + 2.5 \log_{10} (SNR^2 A)  \nonumber \\
 &+& 2.5 \log_{10}(1.0 + A^{-1} 10.0^{-0.4(m^b_{5} - m_{sky})}) 
 \label{SNANASIMLIB}
\eeqn
Eqn.~\ref{SNANASIMLIB} is the approximation used in calculating the zero points in SNANA Simlibs from the OpSim outputs.

\subsection{Background Dominated Limit}

In the background dominated limit, $N_{total} \approx N_{sky},$ 

This further leads to a simplificaton of Eqn.~\ref{SNANASIMLIB} by removing the 
last term. The zero point is thus found to be:
\be
zp_{source} = 2 m^b_5 - m^b_{sky} + 2.5 \log_{10}(SNR^2 A) 
\ee
This term is calculated as \verb zpt_approx  in the SNANA simlib calculation.
\end{document}
